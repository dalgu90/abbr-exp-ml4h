import csv
import html
import os
import re
import sys

cui2txt = {
    "C0001457": "ADENOSINE DEAMINASE",
    "C0001459": "Adenosine Diphosphate",
    "C0001613": "Adrenal Cortex",
    "C0001614": "Adrenal Cortex Diseases",
    "C0001625": "Adrenal Glands",
    "C0001629": "Adrenal Medulla",
    "C0001898": "Alanine",
    "C0001942": "Alcohol dehydrogenase",
    "C0001948": "Alcohol consumption",
    "C0001972": "Alcoholics Anonymous",
    "C0002395": "Alzheimer's Disease",
    "C0002456": "American Dental Association",
    "C0002463": "American Nurses' Association",
    "C0002520": "Amino Acids",
    "C0002563": "Aminolevulinic Acid",
    "C0002736": "Amyotrophic Lateral Sclerosis",
    "C0002876": "Congenital dyserythropoietic anemia",
    "C0002893": "Refractory anemias",
    "C0002895": "Sickle Cell Anemia",
    "C0003243": "Antinuclear Antibody",
    "C0003372": "Antilymphocyte Serum",
    "C0003779": "Argipressin",
    "C0003873": "Rheumatoid Arthritis",
    "C0004374": "Automatic Data Processing",
    "C0004903": "Beckwith-Wiedemann Syndrome",
    "C0005740": "Bleomycin",
    "C0005821": "Blood Platelets",
    "C0005859": "Bloom Syndrome",
    "C0005902": "Body Surface Area",
    "C0006012": "Borderline Personality Disorder",
    "C0006033": "Borrelia (bacteria)",
    "C0006137": "Brazil",
    "C0006147": "Breast Feeding",
    "C0006222": "Bromides",
    "C0006287": "Bronchopulmonary Dysplasia",
    "C0006298": "Brown Fat",
    "C0006304": "Brucella abortus bacterium",
    "C0006675": "Calcium",
    "C0006754": "California",
    "C0006767": "Bone callus",
    "C0006823": "Canada",
    "C0007022": "Carbon Tetrachloride",
    "C0007099": "Carcinoma in Situ",
    "C0007129": "Merkel cell carcinoma",
    "C0007158": "Cardiac Glycosides",
    "C0007578": "Cell Adhesion Molecules",
    "C0007634": "Cells",
    "C0007776": "Cerebral cortex",
    "C0007789": "Cerebral Palsy",
    "C0007799": "Cerebral Ventricles",
    "C0007947": "Chancroids",
    "C0008107": "Chile",
    "C0008115": "China",
    "C0008139": "Chiroptera",
    "C0008310": "Endoscopic Retrograde Cholangiopancreatography",
    "C0008354": "Cholera",
    "C0008359": "Cholera Vaccine",
    "C0008569": "Thin Layer Chromatography",
    "C0008778": "Cilia",
    "C0008838": "Cisplatin",
    "C0008925": "Cleft Palate",
    "C0008928": "Cleidocranial Dysplasia",
    "C0009237": "Coffee",
    "C0009264": "Cold Temperature",
    "C0009443": "Common Cold",
    "C0009563": "Biomechanical compliance",
    "C0010132": "Corticotropin-Releasing Hormone",
    "C0010343": "Croatia",
    "C0010384": "Dental Prosthetic Crown",
    "C0010414": "Infection by Cryptococcus neoformans",
    "C0010415": "Cryptococcus",
    "C0010583": "Cyclophosphamide",
    "C0010980": "Dapsone",
    "C0011037": "Dichlorodiphenyldichloroethane",
    "C0011198": "Delaware",
    "C0011343": "Dental Cementum",
    "C0011389": "Dental Plaque",
    "C0011485": "Deoxycytidine",
    "C0011848": "Diabetes Insipidus",
    "C0011905": "Computer Assisted Diagnosis",
    "C0012020": "Diazooxonorleucine",
    "C0012238": "Digestion",
    "C0012240": "Gastrointestinal system",
    "C0012764": "District of Columbia",
    "C0012931": "Recombinant DNA",
    "C0012933": "Ribosomal DNA",
    "C0013058": "Dosage Forms",
    "C0013220": "Drug Tolerance",
    "C0013570": "Ecthyma",
    "C0013671": "Eels",
    "C0013710": "Egg Food Product",
    "C0013961": "Emergency medical service",
    "C0014063": "Myelin Basic Proteins",
    "C0014563": "Epinephrine",
    "C0014582": "Epirubicin",
    "C0014772": "Red Blood Cell Count measurement",
    "C0014792": "Erythrocytes",
    "C0014921": "Estramustine",
    "C0015063": "Ethyl Methanesulfonate",
    "C0015214": "Evoked Potentials",
    "C0015230": "Exanthema",
    "C0015259": "Exercise",
    "C0015422": "Eyelash",
    "C0015435": "F Factor",
    "C0015625": "Fanconi Anemia",
    "C0015683": "Fatty-acid synthase",
    "C0015923": "Fetal Alcohol Syndrome",
    "C0016163": "Fishes",
    "C0016204": "Flatulence",
    "C0016410": "Folic Acid",
    "C0016538": "Projections and Predictions",
    "C0017067": "Ganglia",
    "C0017110": "Gases",
    "C0017346": "GAG Gene",
    "C0017360": "pol genes",
    "C0017375": "tat Genes",
    "C0017480": "Germany",
    "C0017916": "Phosphorylases",
    "C0017973": "Glycosaminoglycans",
    "C0017977": "Glycosides",
    "C0018064": "Equine Gonadotropins",
    "C0018120": "Ovarian Follicle",
    "C0018481": "Hemophilus ducreyi",
    "C0018810": "heart rate",
    "C0018827": "Heart Ventricle",
    "C0019552": "Hip region structure",
    "C0019564": "Hippocampus (Brain)",
    "C0019682": "HIV",
    "C0019693": "HIV Infections",
    "C0019829": "Hodgkins Disease",
    "C0020202": "Crossbreeding",
    "C0020259": "Hydrochloric Acid",
    "C0020746": "Ice",
    "C0020963": "Immune Tolerance",
    "C0021024": "Complementarity Determining Regions",
    "C0021069": "Immunoprecipitation",
    "C0021171": "Bloch Sulzberger syndrome",
    "C0021246": "Indomethacin",
    "C0021247": "Indonesia",
    "C0021487": "Intra-Arterial Injections",
    "C0021540": "Inosine Triphosphate",
    "C0021740": "Recombinant Interferon-gamma",
    "C0021745": "Interferon Type II",
    "C0021756": "Interleukin-2",
    "C0021759": "Interleukin-5",
    "C0021760": "Interleukin-6",
    "C0021965": "Iodide Peroxidase",
    "C0022023": "Ions",
    "C0022024": "Iontophoresis",
    "C0022037": "Iowa",
    "C0022077": "Iris (Eye)",
    "C0022122": "Bone structure of ischium",
    "C0022171": "Isoelectric Point",
    "C0022326": "Ivory Coast",
    "C0022341": "Japan",
    "C0022521": "Primary Ciliary Dyskinesias",
    "C0022655": "Structure of cortex of kidney",
    "C0022661": "Chronic Kidney Failure",
    "C0022864": "Labor (Childbirth)",
    "C0022925": "Lactation",
    "C0023008": "Languages",
    "C0023078": "Larynx",
    "C0023081": "Laryngeal Prosthesis",
    "C0023281": "Leishmaniasis",
    "C0023308": "Lens Diseases",
    "C0023317": "Eye Lens",
    "C0023318": "Lens (device)",
    "C0023434": "Chronic Lymphocytic Leukemia",
    "C0023443": "Hairy Cell Leukemia",
    "C0024117": "Chronic Obstructive Airway Disease",
    "C0024131": "Lupus Vulgaris",
    "C0024138": "Discoid Lupus Erythematosus",
    "C0024141": "Systemic Lupus Erythematosus",
    "C0024198": "Lyme Disease",
    "C0024487": "Magnetic Resonance Spectroscopy",
    "C0024518": "Major Histocompatibility Complex",
    "C0024530": "Malaria",
    "C0025033": "Mechlorethamine",
    "C0025148": "Medulla Oblongata",
    "C0025235": "Melkersson-Rosenthal Syndrome",
    "C0025611": "Methamphetamine",
    "C0025923": "Inbred DBA Mice",
    "C0026019": "Electron Microscopy",
    "C0026131": "Milk",
    "C0026140": "Human Milk",
    "C0026256": "Mitotane",
    "C0026399": "Moloney murine sarcoma virus",
    "C0026630": "Murine sarcoma viruses",
    "C0026780": "Mumps",
    "C0026934": "Mycoplasma",
    "C0027100": "Myosin Heavy Chains",
    "C0027708": "Nephroblastoma",
    "C0027819": "Neuroblastoma",
    "C0027960": "Nevus",
    "C0027972": "New Mexico",
    "C0028587": "Nuclear Pore",
    "C0028602": "Nucleic Acid Hybridization",
    "C0028652": "Nurse Administrator",
    "C0028654": "Clinical Nurse Specialists",
    "C0028661": "Nurses",
    "C0028677": "Discipline of Nursing",
    "C0028768": "Obsessive-Compulsive Disorder",
    "C0028905": "Ohio",
    "C0029421": "Osteochondritis Dissecans",
    "C0029974": "Ovum",
    "C0030131": "p-Chloroamphetamine",
    "C0030163": "Artificial cardiac pacemaker",
    "C0030583": "Parotitis",
    "C0030625": "Passive Cutaneous Anaphylaxis",
    "C0030779": "Pelger-Huet Anomaly",
    "C0030855": "Pentachlorophenol",
    "C0031106": "Juvenile Periodontitis",
    "C0031336": "Pharmacy (field)",
    "C0031381": "Phencyclidine",
    "C0031642": "Phosphoenolpyruvate",
    "C0031705": "Phosphorus",
    "C0031858": "Phytohemagglutinins",
    "C0032009": "Posterior Pituitary Gland",
    "C0032017": "Posterior Pituitary Hormones",
    "C0032064": "Plague",
    "C0032066": "Plague Vaccine",
    "C0032143": "Alteplase",
    "C0032172": "Platelet Activating Factor",
    "C0032181": "Platelet Count measurement",
    "C0032241": "Pleuropneumonia",
    "C0032246": "Ploidies",
    "C0032305": "Pneumocystis Pneumonia",
    "C0032356": "Country of Poland",
    "C0032447": "Polychlorinated Biphenyls",
    "C0032533": "Polymyalgia Rheumatica",
    "C0032580": "Adenomatous Polyposis Coli",
    "C0032624": "Polyvinyl Chloride",
    "C0032821": "Potassium",
    "C0033036": "Atrial Premature Complexes",
    "C0033223": "Procarbazine",
    "C0033348": "Programming Languages",
    "C0033363": "Projection Defense Mechanism",
    "C0033477": "Propionibacterium acnes",
    "C0034044": "Puerto Rico",
    "C0034625": "Radium",
    "C0034833": "Progesterone Receptor",
    "C0035203": "Respiration",
    "C0035236": "Respiratory syncytial virus",
    "C0035298": "Retina",
    "C0035331": "Retinaldehyde",
    "C0035335": "Retinoblastoma",
    "C0035930": "Rubidium",
    "C0036202": "Sarcoidosis",
    "C0036220": "Kaposi Sarcoma",
    "C0036319": "Schistosoma mansoni",
    "C0036330": "Schistosoma mansonii infection",
    "C0036563": "Plant seeds",
    "C0036614": "Seminal fluid",
    "C0036774": "Bovine Serum Albumin",
    "C0036881": "Sex Factors",
    "C0037019": "Shy-Drager Syndrome",
    "C0037189": "Sinoatrial Node",
    "C0037231": "Sjogren-Larsson Syndrome",
    "C0037473": "Sodium",
    "C0037506": "Sodium Dodecyl Sulfate",
    "C0037570": "Dietary Sodium",
    "C0038160": "Staphylococcal Infections",
    "C0038170": "Genus staphylococcus",
    "C0038280": "Sterilization for infection control",
    "C0038288": "Sexual sterilization",
    "C0038395": "Streptococcal Infections",
    "C0038402": "Streptococcus",
    "C0039021": "Switzerland",
    "C0039062": "Synapses",
    "C0039101": "synovial sarcoma",
    "C0039277": "Talus",
    "C0039341": "tat Protein",
    "C0039371": "Taxes",
    "C0039483": "Giant Cell Arteritis",
    "C0039493": "Temporomandibular Joint",
    "C0039496": "Temporomandibular Joint Dysfunction Syndrome",
    "C0039654": "Tetradecanoylphorbol Acetate",
    "C0039756": "Thematic Apperception Test",
    "C0040052": "Thrombopoietin",
    "C0040079": "Thymidine Monophosphate",
    "C0040112": "Thymus Extracts",
    "C0040113": "Thymus Gland",
    "C0040162": "Thyrotropin-Releasing Hormone",
    "C0040395": "tomography",
    "C0040405": "X-Ray Computed Tomography",
    "C0040441": "Tooth Fractures",
    "C0040452": "Tooth root structure",
    "C0040509": "Total Lung Capacity",
    "C0040975": "Triethylenemelamine",
    "C0041041": "Trimethoprim",
    "C0041070": "Trinitrotoluene",
    "C0041484": "MONOPHENOL MONOOXYGENASE",
    "C0041485": "Tyrosine",
    "C0041618": "Ultrasonography",
    "C0041703": "United States",
    "C0041713": "United States Federal Trade Commission",
    "C0042615": "Veterinary Medicine (discipline)",
    "C0043041": "Wasps",
    "C0043117": "Autoimmune Thrombocytopenia",
    "C0043227": "Work",
    "C0043395": "Yellow Fever",
    "C0051405": "alpha-Linolenic Acid",
    "C0056208": "Complementary RNA",
    "C0062534": "Hepatocyte Growth Factor",
    "C0063146": "Hydroxyl Radical",
    "C0065661": "Mannose Binding Lectin",
    "C0076088": "Tenascin",
    "C0077400": "Troponin C",
    "C0077404": "Troponin T",
    "C0078944": "Patient-Controlled Analgesia",
    "C0079504": "Hermanski-Pudlak Syndrome",
    "C0079786": "Macrophage-Activating Factors",
    "C0079941": "Open Reading Frames",
    "C0080014": "Dietary Phosphorus",
    "C0085077": "Sweet Syndrome",
    "C0085104": "Drug Delivery Systems",
    "C0085105": "Breast Self-Examination",
    "C0085113": "NF1 gene",
    "C0085163": "Crack Cocaine",
    "C0085209": "Bovine Spongiform Encephalopathy",
    "C0085298": "Sudden Cardiac Death",
    "C0085952": "Coffea plant",
    "C0086943": "Rous sarcoma virus",
    "C0092801": "Cladribine",
    "C0114838": "dopamine transporter",
    "C0135981": "Peplomycin",
    "C0144576": "Paclitaxel",
    "C0148873": "WT1 Protein",
    "C0149576": "Structure of posterior cerebral artery",
    "C0151636": "Premature ventricular contractions",
    "C0162638": "Apoptosis",
    "C0162678": "Neurofibromatoses",
    "C0162731": "Scanning Transmission Electron Microscopy Procedures",
    "C0162789": "Fluorescent in Situ Hybridization",
    "C0162800": "Dietary Potassium",
    "C0162804": "MCC gene",
    "C0162832": "APC gene",
    "C0162854": "Commonwealth of Independent States",
    "C0164209": "Substance P Receptor",
    "C0175702": "Williams Syndrome",
    "C0178551": "chorioallantoic membrane",
    "C0206212": "Veterinary technician",
    "C0206255": "Malaria Vaccines",
    "C0206601": "United States Office of Research Integrity",
    "C0206682": "Follicular thyroid carcinoma",
    "C0209338": "Chemokine (C-C Motif) Ligand 4",
    "C0220756": "Niemann-Pick Disease",
    "C0221971": "Hair follicle structure",
    "C0225984": "Structure of anatomic arteriovenous anastomosis",
    "C0226993": "Tooth Crowns",
    "C0238052": "Cerebrotendinous Xanthomatosis",
    "C0242726": "Plant Roots",
    "C0242767": "Stem of plant",
    "C0242872": "Hemlock",
    "C0242961": "Replication Origin",
    "C0242994": "Hantavirus Infections",
    "C0258432": "Wiskott-Aldrich Syndrome Protein",
    "C0265252": "Coffin-Lowry syndrome",
    "C0282636": "Cell Respiration",
    "C0301508": "Yellow Fever Vaccine",
    "C0302363": "Brucella abortus infection",
    "C0302583": "Iron",
    "C0324740": "Talpidae",
    "C0330845": "Genus Astragalus",
    "C0333463": "Senile Plaques",
    "C0343084": "Capillary Leak Syndrome",
    "C0376154": "Skin callus",
    "C0376520": "Dietary Iron",
    "C0376526": "human herpesvirus 8",
    "C0398791": "Nijmegen Breakage Syndrome",
    "C0429865": "Principal Component Analysis",
    "C0452240": "Physical therapy exercises",
    "C0534519": "Caspase-1",
    "C0553730": "Calcium pyrophosphate deposition disease",
    "C0597258": "Genus Pneumocystis",
    "C0597731": "Surface Plasmon Resonance",
    "C0598501": "Chromosome Pairing",
    "C0626201": "Neuregulin 1",
    "C0677644": "Electron energy loss spectroscopy",
    "C0678118": "Transmission Electron Microscopy",
    "C0684204": "Arteriovenous anastomosis procedure",
    "C0684271": "Drinking function",
    "C0751951": "Central Core Myopathy (disorder)",
    "C0752045": "Lawsonia",
    "C0752253": "Neuregulins",
    "C0812425": "S-Phase Fraction",
    "C0851346": "Radiation",
    "C0917783": "Muscle Form Glycogen Phosphorylase",
    "C0919482": "MAF Protein",
    "C0927232": "Neuraxis",
    "C0949780": "P1 Bacteriophage Artificial Chromosomes",
    "C0949851": "Tsuga",
    "C0950121": "Denys-Drash Syndrome",
    "C1001362": "Iris",
    "C1015036": "Thymus",
    "C1068388": "Lawsonia",
    "C1136359": "Cellular Phone",
    "C1175175": "Severe Acute Respiratory Syndrome",
    "C1175743": "SARS coronavirus",
    "C1258666": "Myxoid cyst",
    "C1260899": "Diamond-Blackfan Anemia",
    "C1321571": "Certified registered nurse anesthetist",
    "C1321605": "Compliance behavior",
    "C1522449": "Therapeutic radiology procedure",
    "C1533692": "Tooth eruption function",
    "C1548483": "leishmaniasis vaccine",
    "C1623258": "Electrocardiography",
    "C1706094": "Dental Cement Material",
    "C1956346": "Coronary Artery Disease",
    "C2004493": "B-Cell Leukemia"
}


def main():
    with open(os.path.join(sys.argv[1], 'benchmark_mesh.txt'), 'r', encoding='iso8859_2') as f:
        lst = [line.strip().split('\t') for line in f]
    num_negs = 4
    cnt = 0
    with open(os.path.join(sys.argv[2]), 'w', encoding='utf-8') as f_out:
        writer = csv.writer(f_out, delimiter='\t', quotechar=None)
        writer.writerow(['index', 'group', 'left', 'right', 'label'] + [f'neg_{i}' for i in range(num_negs)])
        for line in lst:
            abbr = line[0]
            cuis = line[1:]
            assert len(cuis) <= num_negs + 1
            with open(os.path.join(sys.argv[1], f'{abbr}_pmids_tagged.arff'), 'r', encoding='iso8859_2') as f:
                for li in f:
                    if li.startswith('@RELATION'):
                        li = li.strip()[10:].split('_')
                        assert tuple(li) == tuple(cuis)
                        continue
                    if li.startswith('@DATA'):
                        break
                reader = csv.reader(f, delimiter=',', quotechar='"')
                for _, txt, label in reader:
                    txt = html.unescape(txt.strip()).strip()
                    assert len(re.findall(r'<e>(.*?)</e>', txt)) == 1
                    mat = re.match(r'(.*)<e>(.*?)</e>(.*)', txt)
                    left, right = mat[1], mat[3]
                    assert label.startswith('M')
                    label = int(label[1:]) - 1
                    txt_label = cui2txt[cuis[label]]
                    txt_negs = [cui2txt[cui] for i, cui in enumerate(cuis) if i != label]
                    while len(txt_negs) < num_negs:
                        txt_negs.append(' ')
                    writer.writerow([cnt, abbr, left, right, txt_label] + txt_negs)
                    cnt += 1


if __name__ == '__main__':
    main()
